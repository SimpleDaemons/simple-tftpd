# -*- mode: ruby -*-
# vi: set ft=ruby :

# Multi-VM Vagrantfile for simple-tftpd
# Manages VMs in the automation/vagrant/virtuals/ directory structure

Vagrant.configure("2") do |config|
  # Define VM configurations
  vm_configs = {
    "ubuntu_dev" => {
      box: "ubuntu/jammy64",
      hostname: "simple-tftpd-ubuntu-dev",
      ip: "192.168.1.100",
      memory: "2048",
      cpus: 2
    },
    "centos_dev" => {
      box: "centos/8",
      hostname: "simple-tftpd-centos-dev", 
      ip: "192.168.1.101",
      memory: "2048",
      cpus: 2
    }
  }
  
  # Get the VM type from environment variable or default to ubuntu_dev
  vm_type = ENV['VAGRANT_BOX'] || "ubuntu_dev"
  
  # Validate VM type
  unless vm_configs.key?(vm_type)
    puts "Error: Unknown VM type '#{vm_type}'"
    puts "Available types: #{vm_configs.keys.join(', ')}"
    exit 1
  end
  
  vm_config = vm_configs[vm_type]
  
  # VM configuration
  config.vm.box = vm_config[:box]
  config.vm.hostname = vm_config[:hostname]
  
  # Network configuration
  config.vm.network "private_network", ip: vm_config[:ip]
  
  # VM resources
  config.vm.provider "virtualbox" do |vb|
    vb.name = vm_config[:hostname]
    vb.memory = vm_config[:memory]
    vb.cpus = vm_config[:cpus]
    vb.gui = false  # Use headless mode
  end
  
  # Provisioning with Ansible
  config.vm.provision "ansible" do |ansible|
    ansible.playbook = "automation/ansible/playbook.yml"
    ansible.inventory_path = "automation/ansible/inventory.ini"
    ansible.limit = "development"
    ansible.extra_vars = {
      git_repo_url: ".",
      git_branch: "main"
    }
    ansible.verbose = true
  end
  
  # Shared directories for development
  config.vm.synced_folder ".", "/vagrant", type: "rsync", 
    rsync__exclude: [".git/", "dist/", "*.o", "*.so", "*.a", "automation/vagrant/virtuals/", ".vagrant/"]
  
  # Application source code (read-write for development)
  config.vm.synced_folder "./src", "/opt/simple-tftpd/src", type: "rsync"
  config.vm.synced_folder "./include", "/opt/simple-tftpd/include", type: "rsync"
  config.vm.synced_folder "./tests", "/opt/simple-tftpd/tests", type: "rsync"
  config.vm.synced_folder "./config", "/opt/simple-tftpd/config", type: "rsync"
  
  # Build directory (read-write for build artifacts)
  config.vm.synced_folder "./build", "/opt/simple-tftpd/build", type: "rsync"
end

