#!/bin/bash
# Build script for Vagrant VM
# Usage: ./vm-build [vm_name] [clean|test|install]

set -e

# Get VM name from first argument or default to ubuntu_dev
VM_NAME="${1:-ubuntu_dev}"
VM_DIR="automation/vagrant/virtuals/$VM_NAME"

# Check if VM directory exists
if [ ! -d "$VM_DIR" ]; then
    echo "âŒ VM directory $VM_DIR not found"
    echo "Available VMs: ubuntu_dev, centos_dev"
    exit 1
fi

# Change to VM directory
cd "$VM_DIR"

# Check if Vagrant VM is running
if ! vagrant status | grep -q "running"; then
    echo "Starting Vagrant VM..."
    vagrant up
fi

# Sync files to VM
echo "Syncing files to VM..."
vagrant rsync

# Run build commands on VM
case "${2:-build}" in
    "clean")
        echo "Cleaning build directory..."
        vagrant ssh -c "cd /opt/simple-tftpd && sudo -u tftpddev rm -rf build && mkdir -p build"
        ;;
    "test")
        echo "Running tests..."
        vagrant ssh -c "cd /opt/simple-tftpd/build && sudo -u tftpddev make test"
        ;;
    "install")
        echo "Installing service..."
        vagrant ssh -c "cd /opt/simple-tftpd && sudo systemctl enable simple-tftpd && sudo systemctl start simple-tftpd"
        ;;
    "status")
        echo "Checking service status..."
        vagrant ssh -c "sudo systemctl status simple-tftpd --no-pager"
        ;;
    "logs")
        echo "Showing service logs..."
        vagrant ssh -c "sudo journalctl -u simple-tftpd -f"
        ;;
    *)
        echo "Building project..."
        vagrant ssh -c "cd /opt/simple-tftpd && sudo -u tftpddev ./build.sh"
        ;;
esac

# Return to original directory
cd - > /dev/null
